# AIOps API 测试指南

## 前提条件

1. **启动应用**
   - 在IDE中运行 `AiopsApplication`
   - 或使用命令：`mvn spring-boot:run`
   - 应用启动在：`http://localhost:8080`

2. **确认服务启动**
   - 查看控制台日志，确认无启动错误
   - 看到 "Started AiopsApplication" 表示启动成功

## 使用Apipost测试

### 步骤1：创建接口

在Apipost中创建新接口：

**接口1：接收群消息**
- **请求方式**：POST
- **URL**：`http://localhost:8080/api/wechat/webhook`
- **Headers**：
  ```
  Content-Type: application/json
  ```
- **Body**：选择 `raw` → `JSON`

### 步骤2：测试用例

#### 测试用例1：完整报修消息（有位置和描述）

**请求Body：**
```json
{
  "senderUserId": "user001",
  "groupId": "group001",
  "content": "我家3-201的灯坏了，需要维修",
  "timestamp": 1705046400000
}
```

**预期响应：**
- HTTP Status: 200
- `status`: "SAVED"
- `actionable`: true
- `intent`: "REPAIR"
- `location`: "3-201"
- `description`: 包含"灯坏了"

**检查点：**
- ✅ 应该保存到数据库
- ✅ AI分析结果正确

---

#### 测试用例2：信息不全（只有描述，没有位置）

**请求Body：**
```json
{
  "senderUserId": "user002",
  "groupId": "group001",
  "content": "灯坏了",
  "timestamp": 1705046400000
}
```

**预期响应：**
- HTTP Status: 202
- `status`: "NEED_MORE_INFO"
- `actionable`: false
- `missingInfo`: 应该包含"位置"相关信息
- `suggestedReply`: 应该有追问建议

**检查点：**
- ✅ 不应该保存到数据库
- ✅ AI识别出信息不全
- ✅ 有追问建议

---

#### 测试用例3：投诉类型消息

**请求Body：**
```json
{
  "senderUserId": "user003",
  "groupId": "group001",
  "content": "3-201的楼上太吵了，影响休息",
  "timestamp": 1705046400000
}
```

**预期响应：**
- HTTP Status: 200
- `status`: "SAVED"
- `intent`: "COMPLAINT"
- `actionable`: true

---

#### 测试用例4：咨询类型消息

**请求Body：**
```json
{
  "senderUserId": "user004",
  "groupId": "group001",
  "content": "物业费什么时候交？",
  "timestamp": 1705046400000
}
```

**预期响应：**
- HTTP Status: 200
- `intent`: "INQUIRY"
- `actionable`: true

---

#### 测试用例5：闲聊消息（应该被过滤）

**请求Body：**
```json
{
  "senderUserId": "user005",
  "groupId": "group001",
  "content": "收到，谢谢",
  "timestamp": 1705046400000
}
```

**预期响应：**
- HTTP Status: 202
- `intent`: "NOISE"
- `actionable`: false

**检查点：**
- ✅ 不应该保存到数据库
- ✅ AI识别为闲聊

---

#### 测试用例6：带图片的消息

**请求Body：**
```json
{
  "senderUserId": "user006",
  "groupId": "group001",
  "content": "3-201的卫生间漏水了",
  "imageUrl": "https://example.com/image.jpg",
  "timestamp": 1705046400000
}
```

**预期响应：**
- HTTP Status: 200
- AI应该分析图片内容
- `imageTextConsistent`: true/false

---

#### 测试用例7：多轮对话测试

**第一步：发送不完整信息**
```json
{
  "senderUserId": "user007",
  "groupId": "group001",
  "content": "灯坏了",
  "timestamp": 1705046400000
}
```

**等待5-10秒后，第二步：补全位置信息**
```json
{
  "senderUserId": "user007",
  "groupId": "group001",
  "content": "在3-201的客厅",
  "timestamp": 1705046700000
}
```

**预期结果：**
- 第一步：`status`: "NEED_MORE_INFO"
- 第二步：AI应该结合历史记忆，`status`: "SAVED"

---

#### 测试用例8：参数校验测试（缺少senderUserId）

**请求Body：**
```json
{
  "groupId": "group001",
  "content": "测试消息"
}
```

**预期响应：**
- HTTP Status: 400 Bad Request
- `status`: "ERROR"
- `message`: "发送者ID不能为空"

---

#### 测试用例9：参数校验测试（缺少groupId）

**请求Body：**
```json
{
  "senderUserId": "user008",
  "content": "测试消息"
}
```

**预期响应：**
- HTTP Status: 400 Bad Request
- `message`: "群ID不能为空"

---

### 步骤3：查询草稿接口

**接口2：查询草稿**
- **请求方式**：GET
- **URL**：`http://localhost:8080/api/wechat/drafts?groupId=group001`
- **Headers**：无

**预期响应：**
- HTTP Status: 200
- 返回该群组的待处理工单草稿数组
- 按创建时间倒序排列

---

## 测试检查清单

### 功能检查
- [ ] 接口能正常接收请求
- [ ] 参数校验正常工作
- [ ] 异常处理正常

### AI分析检查
- [ ] 意图识别正确（REPAIR/COMPLAINT/INQUIRY/NOISE）
- [ ] 位置信息提取正确
- [ ] 紧急程度判断合理
- [ ] 信息完整性判断正确

### 业务逻辑检查
- [ ] 完整信息入库（actionable=true → status=SAVED）
- [ ] 不完整信息不入库（actionable=false → status=NEED_MORE_INFO）
- [ ] 多轮对话记忆生效
- [ ] 消息去重生效（相同内容短时间内重复发送）

### 数据检查
- [ ] 数据库正确保存（查询drafts接口确认）
- [ ] Redis记忆正确存储（多轮对话测试）
- [ ] 日志记录完整（查看控制台日志）

## 常见问题排查

### 1. 接口返回404
- 检查应用是否启动
- 检查URL是否正确：`/api/wechat/webhook`
- 查看控制台日志

### 2. AI分析返回错误
- 检查通义千问API Key配置（application.properties）
- 检查网络连接
- 查看控制台日志中的错误信息

### 3. 数据库保存失败
- 检查数据库连接配置
- 检查表是否存在：`work_order_drafts`
- 查看控制台日志

### 4. 多轮对话不生效
- 检查Redis连接配置
- 检查记忆有效期配置（默认30分钟）
- 查看Redis中是否有key：`aiops:memory:userXXX`

## 日志查看

关键日志关键词：
- `收到群消息:` - 接收到的消息
- `AI 分析结果:` - AI分析结果详情
- `【入库成功】` - 成功保存草稿
- `【拦截入库】` - 信息不全，不入库
- `检测到重复消息` - 消息去重生效
- `调用外部下单接口` - 下单接口调用（如果启用）

## 测试数据准备

测试前可以清理测试数据：
```sql
-- 清理测试草稿
DELETE FROM work_order_drafts WHERE groupId = 'group001';

-- 清理测试业主（如果需要）
DELETE FROM owners WHERE senderId LIKE 'user%';
```

---

**提示**：建议按照测试用例顺序进行测试，以便观察多轮对话等功能的正确性。
